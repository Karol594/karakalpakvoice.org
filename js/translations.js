/* KarakalpakVoice.org - Translation System */
/* 4 Languages: Russian, Karakalpak, English, Polish */
/* SECURITY FIRST - No sensitive information in translations */

// Translation data object
const translations = {
  // RUSSIAN (Default) - Русский
  ru: {
    // Site Meta
    site_title: "KarakalpakVoice.org",
    site_subtitle: "Независимая информационная платформа",
    
    // Navigation
    nav_home: "Главная",
    nav_sovereignty: "Суверенитет", 
    nav_news: "Новости",
    nav_politics: "Политика",
    nav_history: "История",
    nav_sports: "Спорт",
    nav_geography: "География",
    nav_culture: "Традиции",
    nav_religion: "Религия",
    nav_about: "О нас",
    
    // Hero Section
    hero_title: "Голос Каракалпакстана",
    hero_subtitle: "Доносим правду до мирового сообщества без цензуры",
    stat_languages: "языка",
    stat_sections: "разделов", 
    stat_truth: "правды",
    qr_text: "Поделиться сайтом",
    
    // News
    latest_news: "Последние новости",
    loading_news: "Загружаем актуальные новости...",
    
    // Sections
    explore_sections: "Изучайте разделы",
    
    // Footer
    footer_mission: "Миссия: донести голос народа до мирового сообщества",
    footer_location: "Варшава, Польша",
    footer_contact: "Контакты",
    footer_rights: "Все права защищены",
    
    // Security & Admin (NO SENSITIVE INFO)
    security_notice: "Внимание: остерегайтесь поддельных материалов",
    contact_secure: "Безопасные контакты",
    
    // Common UI
    read_more: "Читать далее",
    share_article: "Поделиться",
    back_to_top: "Наверх",
    menu_toggle: "Меню",
    close: "Закрыть",
    loading: "Загрузка...",
    error_message: "Ошибка загрузки",
    try_again: "Попробовать снова"
  },

  // KARAKALPAK - Қарақалпақ тили
  kaa: {
    // Site Meta
    site_title: "KarakalpakVoice.org",
    site_subtitle: "Ғәрезсиз мәлимлеме платформасы",
    
    // Navigation 
    nav_home: "Бас бет",
    nav_sovereignty: "Суверенитет",
    nav_news: "Жаңалықлар", 
    nav_politics: "Сиясат",
    nav_history: "Тарийх",
    nav_sports: "Спорт",
    nav_geography: "География",
    nav_culture: "Дәстүрлер",
    nav_religion: "Дин",
    nav_about: "Биз туўралы",
    
    // Hero Section
    hero_title: "Қарақалпақстан даўысы",
    hero_subtitle: "Цензурасыз ҳақыйқатты дүнья жәмийетшилигине жеткеремиз.",
    stat_languages: "тил",
    stat_sections: "бөлим",
    stat_truth: "ҳақыйқат",
    qr_text: "Сайтты бөлисыў",
    
    // News
    latest_news: "Соңғы жаңалықлар",
    loading_news: "Әҳимийетли жаңалықларды жүклеп атырмыз...",
    
    // Sections
    explore_sections: "Бөлимлерди үйрениң",
    
    // Footer
    footer_mission: "Миссия: халық даўысын дүнья жәмийетшилигине жеткищиў",
    footer_location: "Варшава, Польша",
    footer_contact: "Байланыс",
    footer_rights: "Барлық ҳуқықлар қорғалған",
    
    // Security & Admin (NO SENSITIVE INFO)
    security_notice: "Дыққат: жалған материаллардан сақланың",
    contact_secure: "Қәўипсиз байланыс",
    
    // Common UI
    read_more: "Толығырақ оқыў",
    share_article: "Бөлисыў",
    back_to_top: "Жоқарыға",
    menu_toggle: "Меню",
    close: "Жабыў",
    loading: "Жүклеп атыр...",
    error_message: "Жүклеўде қәтелик",
    try_again: "Қайта тырысыў"
  },

  // ENGLISH
  en: {
    // Site Meta
    site_title: "KarakalpakVoice.org",
    site_subtitle: "Independent Information Platform",
    
    // Navigation
    nav_home: "Home",
    nav_sovereignty: "Sovereignty",
    nav_news: "News", 
    nav_politics: "Politics",
    nav_history: "History",
    nav_sports: "Sports",
    nav_geography: "Geography",
    nav_culture: "Traditions",
    nav_religion: "Religion",
    nav_about: "About",
    
    // Hero Section
    hero_title: "Voice of Karakalpakstan",
    hero_subtitle: "Bringing truth to the world community without censorship",
    stat_languages: "languages",
    stat_sections: "sections",
    stat_truth: "truth",
    qr_text: "Share website",
    
    // News
    latest_news: "Latest News",
    loading_news: "Loading current news...",
    
    // Sections
    explore_sections: "Explore Sections",
    
    // Footer
    footer_mission: "Mission: bring the voice of the people to the world community",
    footer_location: "Warsaw, Poland",
    footer_contact: "Contact",
    footer_rights: "All rights reserved",
    
    // Security & Admin (NO SENSITIVE INFO)
    security_notice: "Warning: beware of fake materials",
    contact_secure: "Secure contacts",
    
    // Common UI
    read_more: "Read more",
    share_article: "Share",
    back_to_top: "Back to top",
    menu_toggle: "Menu",
    close: "Close",
    loading: "Loading...",
    error_message: "Loading error",
    try_again: "Try again"
  },

  // POLISH - Polski
  pl: {
    // Site Meta
    site_title: "KarakalpakVoice.org",
    site_subtitle: "Niezależna platforma informacyjna",
    
    // Navigation
    nav_home: "Strona główna",
    nav_sovereignty: "Suwerenność",
    nav_news: "Wiadomości",
    nav_politics: "Polityka", 
    nav_history: "Historia",
    nav_sports: "Sport",
    nav_geography: "Geografia",
    nav_culture: "Tradycje",
    nav_religion: "Religia",
    nav_about: "O nas",
    
    // Hero Section
    hero_title: "Głos Karakałpakstanu",
    hero_subtitle: "Przekazujemy prawdę społeczności światowej bez cenzury",
    stat_languages: "języków",
    stat_sections: "sekcji",
    stat_truth: "prawdy",
    qr_text: "Udostępnij stronę",
    
    // News
    latest_news: "Najnowsze wiadomości",
    loading_news: "Ładowanie aktualnych wiadomości...",
    
    // Sections
    explore_sections: "Eksploruj sekcje",
    
    // Footer
    footer_mission: "Misja: przekazać głos narodu społeczności światowej",
    footer_location: "Warszawa, Polska",
    footer_contact: "Kontakt",
    footer_rights: "Wszystkie prawa zastrzeżone",
    
    // Security & Admin (NO SENSITIVE INFO)
    security_notice: "Uwaga: strzeżcie się fałszywych materiałów",
    contact_secure: "Bezpieczne kontakty",
    
    // Common UI
    read_more: "Czytaj więcej",
    share_article: "Udostępnij",
    back_to_top: "Na górę",
    menu_toggle: "Menu",
    close: "Zamknij",
    loading: "Ładowanie...",
    error_message: "Błąd ładowania",
    try_again: "Spróbuj ponownie"
  }
};

// Current language state
let currentLanguage = 'ru';

// Translation function
function translate(key, lang = currentLanguage) {
  if (translations[lang] && translations[lang][key]) {
    return translations[lang][key];
  }
  // Fallback to Russian if translation not found
  if (translations['ru'][key]) {
    return translations['ru'][key];
  }
  // Return key if no translation found (for security, don't expose internal keys)
  return key.replace(/_/g, ' ');
}

// Apply translations to page
function applyTranslations(lang = currentLanguage) {
  const elements = document.querySelectorAll('[data-translate]');
  
  elements.forEach(element => {
    const key = element.getAttribute('data-translate');
    const translation = translate(key, lang);
    
    // Security check - don't translate sensitive attributes
    if (key.includes('admin') || key.includes('password') || key.includes('secret')) {
      console.warn('Security: Blocked translation of sensitive key:', key);
      return;
    }
    
    // Check if element is input/textarea
    if (element.tagName === 'INPUT' || element.tagName === 'TEXTAREA') {
      if (element.type === 'submit' || element.type === 'button') {
        element.value = translation;
      } else {
        element.placeholder = translation;
      }
    } else {
      element.textContent = translation;
    }
  });
  
  // Update page title securely
  const titleKey = 'site_title';
  const currentTitle = document.title;
  if (currentTitle && !currentTitle.includes('admin') && !currentTitle.includes('login')) {
    const pageTitle = currentTitle.split(' - ')[0];
    document.title = `${pageTitle} - ${translate(titleKey, lang)}`;
  }
  
  // Update meta description securely
  const metaDesc = document.querySelector('meta[name="description"]');
  if (metaDesc && !metaDesc.content.includes('admin')) {
    metaDesc.content = translate('site_subtitle', lang);
  }
}

// Change language function
function changeLanguage(lang) {
  if (!translations[lang]) {
    console.error(`Language ${lang} not supported`);
    return;
  }
  
  currentLanguage = lang;
  
  // Store in localStorage securely
  try {
    // Only store language preference, no sensitive data
    localStorage.setItem('kv_lang', lang);
  } catch (e) {
    // Handle localStorage not available
    console.warn('Storage not available');
  }
  
  // Update active language button
  const langButtons = document.querySelectorAll('.lang-btn');
  langButtons.forEach(btn => {
    btn.classList.remove('active');
    if (btn.getAttribute('data-lang') === lang) {
      btn.classList.add('active');
    }
  });
  
  // Apply translations
  applyTranslations(lang);
  
  // Update HTML lang attribute
  document.documentElement.lang = lang;
  
  // Trigger custom event for other components
  const event = new CustomEvent('languageChanged', { 
    detail: { language: lang } // Don't expose full translations object
  });
  document.dispatchEvent(event);
}

// Initialize language system securely
function initializeLanguageSystem() {
  // Try to get saved language securely
  let savedLang = 'ru';
  try {
    savedLang = localStorage.getItem('kv_lang') || 'ru';
    // Validate saved language for security
    if (!translations[savedLang]) {
      savedLang = 'ru';
    }
  } catch (e) {
    console.warn('Storage not available, using default language');
  }
  
  // Detect browser language as fallback
  if (savedLang === 'ru') {
    const browserLang = navigator.language || navigator.userLanguage;
    if (browserLang) {
      const langCode = browserLang.split('-')[0];
      if (translations[langCode]) {
        savedLang = langCode;
      }
    }
  }
  
  // Set initial language
  changeLanguage(savedLang);
  
  // Add event listeners to language buttons
  const langButtons = document.querySelectorAll('.lang-btn');
  langButtons.forEach(btn => {
    btn.addEventListener('click', () => {
      const lang = btn.getAttribute('data-lang');
      // Validate language input for security
      if (translations[lang]) {
        changeLanguage(lang);
      }
    });
  });
}

// Get available languages
function getAvailableLanguages() {
  return Object.keys(translations);
}

// Get language name in native script
function getLanguageName(langCode) {
  const languageNames = {
    'ru': 'Русский',
    'kaa': 'Қарақалпақ тили',
    'en': 'English', 
    'pl': 'Polski'
  };
  return languageNames[langCode] || langCode;
}

// Get current language
function getCurrentLanguage() {
  return currentLanguage;
}

// Check if RTL language (for future Arabic support)
function isRTL(lang) {
  const rtlLanguages = ['ar', 'he', 'fa', 'ur'];
  return rtlLanguages.includes(lang);
}

// Format text with language-specific rules
function formatText(text, lang = currentLanguage) {
  if (!text || typeof text !== 'string') return '';
  
  // Add language-specific formatting rules here
  switch (lang) {
    case 'kaa':
      // Karakalpak specific formatting
      return text.trim();
    case 'en':
      // English specific formatting
      return text.trim();
    case 'pl':
      // Polish specific formatting
      return text.trim();
    case 'ru':
    default:
      // Russian specific formatting
      return text.trim();
  }
}

// Security function - sanitize translation keys
function sanitizeKey(key) {
  if (typeof key !== 'string') return '';
  // Remove potentially dangerous characters
  return key.replace(/[<>\"'&]/g, '').substring(0, 50);
}

// Export functions for use in other scripts (limited for security)
window.KarakalpakVoiceTranslations = {
  translate,
  changeLanguage,
  initializeLanguageSystem,
  applyTranslations,
  getAvailableLanguages,
  getLanguageName,
  getCurrentLanguage,
  isRTL,
  formatText
  // Note: translations object NOT exported for security
};

// Auto-initialize when DOM is ready
document.addEventListener('DOMContentLoaded', initializeLanguageSystem);

// Production build - remove debug functions in production
if (typeof window !== 'undefined' && window.location.hostname === 'localhost') {
  // Debug function for development only
  window.debugTranslations = function() {
    console.log('Available languages:', getAvailableLanguages());
    console.log('Current language:', getCurrentLanguage());
  };
}